<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Mushroom Finder: Spots</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=fetch,requestAnimationFrame,Element.prototype.classList,URL"></script>
  <script src="https://openlayers.org/en/v6.5.0/build/ol.js"></script>
  <link rel="stylesheet" href="https://openlayers.org/en/v6.5.0/css/ol.css" type="text/css">
</head>
<body>
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h1>Spots</h1>
      <a href="/map" class="btn btn-secondary">Back to Map</a>
      <form action="#" th:action="@{/spots}" method="get" class="form-inline my-2 my-lg-0">
        <label for="searchTerm" class="sr-only">Search Term:</label>
        <input type="text" id="searchTerm" name="searchTerm" th:value="${searchTerm}" placeholder="search by name" class="form-control mr-sm-2">
        <input type="submit" value="Search" class="btn btn-primary my-2 my-sm-0">
      </form>
      <table class="table">
        <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Picture</th>
          <th>Longitude</th>
          <th>Latitude</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="spot : ${spots}">
          <td th:text="${spot.name}"></td>
          <td th:text="${spot.description}"></td>
          <td><img th:src="@{/spots/picture/{id}(id=${spot.id})}" alt="no picture available" width="100" height="100"></td>
          <td th:text="${spot.longitude}"></td>
          <td th:text="${spot.latitude}"></td>
          <td>
            <a th:href="@{/spots/edit/{id}(id=${spot.id})}" class="btn btn-primary">Edit</a>
			<a th:href="@{/comments/{id}(id=${spot.id})}" class="btn btn-primary">View Comments</a>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<div id="map" class="map" style= "width: 100%; height: 700px" ></div>
<script>
    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            }),
            new ol.layer.Vector({
                source: new ol.source.Vector()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([12.10434300, 49.02391200]),
            zoom: 10
        })
    });

    fetch("/filteredMarkers")
        .then(response => response.json())
        .then(markers => {
            var vectorSource = new ol.source.Vector(); // Create a vector source
            for (var i = 0; i < markers.length; i++) {
                var marker = markers[i];
                var lonLat = [marker.longitude, marker.latitude];
                var point = new ol.geom.Point(ol.proj.fromLonLat(lonLat)); // Create a point feature
                var feature = new ol.Feature({
                    geometry: point,
                    id: marker.id
                });
                vectorSource.addFeature(feature); // Add the feature to the vector source
            }
            var markerStyle = new ol.style.Style({
                image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                    anchor: [0.5, 0.5],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'fraction',
                    src: '../marker.png'
                }))
            });
            var vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: markerStyle
            });
            map.addLayer(vectorLayer); // Add the vector layer to the map

            // Add a click event listener to the vector layer
            vectorLayer.on("click", function(event) {
                // Get the feature that was clicked
                var feature = event.feature;
                // Get the id of the mushroom associated with the feature
                var mushroomId = feature.get("id");
                // Redirect the user to the mushroom page
                window.location.href = "/mushroom/" + mushroomId;
            });

        });
</script>
</body>
</html>